''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' Product        :  Paging
'
' Name           :  pg_daemon.cbs
'
' Description    :  Provides background processing of files generated by pager_clerk
'                   for conversion to Paging serial interface files, and processing of
'                   response files received from RPA.
'
' Author          : First Choice Software, Inc.
'                   8900 Business Park Drive
'                   Austin, TX 78759
'                   (512) 418-2905
'
' Platforms       : This version supports Clarify 5.0 and later
'
' Copyright (C) 2001 First Choice Software, Inc.
' All Rights Reserved
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
OPTION EXPLICIT
Global locale     As String

Dim db_key        As String             'database name
Dim err_file      As String             'daemon error file
Dim err_string    As String             'error message
Dim fcs_dir       As String             'request file location
Dim from_rpa_dir  As String             'folder for pgpt responses from rpa
Dim in_file       As String             'current input file
Dim log_dir       As String             'daemon log file location
Dim log_file      As String             'daemon log file
Dim out_file      As String             'serial interface output file
Dim pg_dir        As String             'serial interface/response location
Dim pm_path       As String             'path to pagemate command line software
Dim pm_rpa        As String             'switch for pagemate or rpa use
Dim send_rpa_dir  As String             'folder for pgpt requests going to rpa
Dim sep_val       As String             'pathname seperator
Dim shell_file    As String             'filename of daemon start process
Dim sv_key        As String             'server name
Dim tmp_string    As String             'tmp string for errors
Dim user_name     As String             'user name
Dim win_type      As Boolean            'True=PC, False=Unix

'global ini file values
Dim sleep_time    As Long               'how long to sleep between scans in seconds
Dim cycle_num     As Long               'how many times to scan before respawning
Dim log_level     As Integer            'log level requested (0=none, 1=normal, 2=debug)
Dim db_type       As String             'Database Type

'gobal config item values
Dim create_api_request_event            As Boolean    '
Dim create_api_request_focus_act_entry  As Boolean    '
Dim create_api_response_event           As Boolean    '
Dim create_api_response_focus_act_entry As Boolean    '
Dim create_notify_response_focus_act_entry As Boolean '
Dim customer_id                         As String     'RPA assigned custom id
Dim customer_name                       As String     'RPA assigned custom name
Dim max_request                         As Integer    '# of request files to process in batch
Dim max_response                        As Integer    '# of response files to process in batch
Dim response_filter                     As String     'response types to process
Dim track_api_request                   As Boolean    '
Dim track_api_response                  As String     '
Dim track_notify_request                As Boolean    '
Dim track_notify_response               As String     '
Dim use_notify_focus_tag                As Boolean    '

'global record identifiers
Dim case_objid                 As Long  'focus case
Dim subcase_objid              As Long  'focus subcase
Dim employee_objid             As Long  'focus employee
Dim user_objid                 As Long  'user for act_entry relation
Dim gbst_objid                 As Long  'gbst_elm for act_entry relation

Dim exclude_filter As String            'response filter global variables
Dim include_filter As String
Dim ignore_filter  As String
Dim response_types As String

'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' Get internationalized message strings
'
' Copyright (C) 2001 First Choice Software, Inc. All Rights Reserved
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Function sprintf(in_str As String, Optional arg1 As Variant, _
                 Optional arg2 As Variant, Optional arg3 As Variant, _
                 Optional arg4 As Variant, Optional arg5 As Variant, _
                 Optional arg6 As Variant) As String
  Dim t_str  As String
  Dim par    As String
  Dim t_int  As Integer
  Dim t_loc  As Integer
  Dim t_char As String
  Dim t_var  As Variant

  t_str = in_str
  For t_int = 1 To 6
    par = "%" + Trim$(Str$(t_int))
    t_loc = Instr(t_str, par)
    If t_loc > 0 Then
     Select Case t_int
      Case 1
       t_var = arg1
      Case 2
       t_var = arg2
      Case 3
       t_var = arg3
      Case 4
       t_var = arg4
      Case 5
       t_var = arg5
      Case 6
       t_var = arg6
     End Select

     t_char = UCase(Mid$(t_str, t_loc + 2, 1))
     Select Case t_char
       Case "L"
        If UCase(Mid$(t_str, t_loc + 3, 1)) = "D" Then
           t_str = Left$(t_str, t_loc - 1) + CStr(t_var) + _
                   Mid$(t_str, t_loc + 4, Len(t_str) - 5)
        End If
       Case "D"
        t_str = Left$(t_str, t_loc - 1) + CStr(t_var) + _
                Mid$(t_str, t_loc + 3, Len(t_str) - 4)
       Case Else
        t_str = Left$(t_str, t_loc - 1) + CStr(t_var) + _
                Mid$(t_str, t_loc + 3, Len(t_str) - 4)

     End Select
    End If
  Next t_int
  sprintf = t_str
End Function

'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' Get internationalized string from fc_table
'
' Copyright (C) 2001 First Choice Software, Inc. All Rights Reserved
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Function get_sprintf(str_num As Long, locale As String, application As String, _
                     Optional arg1 As Variant, Optional arg2 As Variant, _
                     Optional arg3 As Variant, Optional arg4 As Variant, _
                     Optional arg5 As Variant, Optional arg6 As Variant) As String
  Dim t_ret  As New BulkRetrieve
  Dim t_list As List
  Dim t_rec  As Record

  t_ret.SimpleQuery 0, "fc_string"
  t_ret.AppendFilter 0, "locale", cbEqual, locale
  t_ret.AppendFilter 0, "id", cbEqual, str_num
  t_ret.AppendFilter 0, "application", cbLike, application + "%"
  t_ret.RetrieveRecords
  Set t_list = t_ret.GetRecordList(0)
  If t_list.Count = 0 Then
     get_sprintf = ""
     Exit Function
  End If
  Set t_rec = t_list.ItemByIndex(0)
  get_sprintf = sprintf(t_rec.GetField("string"), arg1, arg2, arg3, arg4, arg5, arg6)
End Function

'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' Delete a Specified File
'
' Copyright (C) 2001 First Choice Software, Inc. All Rights Reserved
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Sub del_file(file_name As String)
  On Error Goto no_such_file            'Set error trap
  Kill file_name                        'Delete the file
no_such_file:
  On Error Goto 0                       'Clear the error trap
End Sub

'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' error message output function
'
' Copyright (C) 2001 First Choice Software, Inc. All Rights Reserved
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Sub error_msg(the_msg As String, line_num As Integer)
  If line_num > 0 Then                  'Print to error file with/without the line number
     Print #4, "[" + Format(Now(), "hh:nn:ss") + "] Record " + _
      Trim$(Str$(line_num)) + ". " + the_msg
  Else
     Print #4, "[" + Format(Now(), "hh:nn:ss") + "] " + the_msg
  End If
End Sub

'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' Open & check the required files
'
' Copyright (C) 2001 First Choice Software, Inc. All Rights Reserved
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Function open_error_files()
  Dim cur_time As Date                  'Current date/time in date format
  cur_time = CDate(App.CurrentDate)     'Get the current time
  err_file = "pg_daemon_error.log"      'file name for error files

  del_file err_file                     'Delete files from last run

  On Error Goto file_error              'set error trap
  err_string = err_file
  Open err_file For Append As #4        'Open error file and print header
  Print #4, "Errors for pg_daemon"
  Print #4, "Date of Interface: " + Format(cur_time, "mm/dd/yy")
  Print #4,

  On Error Goto 0
  Exit Function
file_error:
  open_error_files = -400
  On Error Goto 0
End Function

'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' Open log files
'
' Copyright (C) 2001 First Choice Software, Inc. All Rights Reserved
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Function open_pg_files()
  Dim cur_time As Date                  'Current date/time in date format
  cur_time = CDate(App.CurrentDate)     'Get the current time

  On Error Goto missing_file            'set error trap
  Open log_file For Append As #2        'Open log file and print header
  Print #2, "log file for pg_daemon"
  Print #2, "Date of Interface: " + Format(cur_time, "c")
  Print #2,
  Close #2                              'Close log file  **03-17-99**

  On Error Goto 0
  Exit Function
missing_file:
  open_pg_files = -400
  err_string = log_file
  On Error Goto 0
End Function

'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' this sub writes to the log_file based on the specified log_level and message level
'
' Copyright (C) 2001 First Choice Software, Inc. All Rights Reserved
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Sub logmsg(log_lvl As Integer, log_str As String)
  Dim pos As Integer

  If log_lvl <= log_level Then          'if log level is high enough, write message
    Open log_file For Append As #2      'Open log file  **03-17-99**
    Print #2, log_str
    Close #2                            'Close log file  **03-17-99**
                                        'next three lines commented out **03-17-99**
    If log_lvl > 1 Then
                                        'this while loop has been added to prevent a known debug.print crash
                                        ' for more info see
                                        'http://esupport.clarify.com/jaguar/eSupport/SolutionShow.asp?solution_id=PD15465
                                        'CBbatch: Debug.Message Truncates Output String if Containing Percent Sign (%)
      pos = InStr(log_str, "%")
      While pos > 0
        log_str = Mid(log_str,1,pos-1) & "%%" & Mid(log_str,pos+1)
        pos = InStr(pos+2, log_str, "%")
      Wend

      Debug.Print log_str               'if in debug mode, write to screen also
    End If
  End If
End Sub

'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' Initialize Variables
'
' Copyright (C) 2001 First Choice Software, Inc. All Rights Reserved
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Function read_ini_file()
  Dim in_line  As String                'input line read from input file
  Dim line_num As Integer               'line counter for input file
  Dim pos1     As Integer               'parsing variables
  Dim pos2     As Integer
  Dim keyword  As String
  Dim keyvalue As String

  On Error Goto missing_file              'set error trap
  in_file = CurDir$ & sep_val & "pg.ini"  'set pathname
  If log_level = 3 Then
    debug.print in_file
  End If

  Open in_file For Input As #1            'open ini file

  line_num = 1                            'init line counter
  While Not EOF(1)                        'loop through ini file
    On Error Goto error_in_parse          'If any parsing errors, trap and continue
    Line Input #1, in_line

    If Left$(in_line,1) = " " or _
       Left$(in_line,1) = ";" Then
        goto next_line
    End If

    pos1 = Instr(in_line, "=")
    if pos1 > 0 then
      keyword = Left$(in_line,pos1 - 1)
      keyvalue = Mid$(in_line,pos1 + 1)
      Select Case UCase$(keyword)
        Case "SLEEP"
          sleep_time = CLng(keyvalue)
        Case "CYCLE"
          cycle_num = CLng(keyvalue)
        Case "LOG_LVL"
          log_level = CLng(keyvalue)
        Case "FCS_DIR"
          if right$(keyvalue,1) = sep_val Then
            fcs_dir = keyvalue
          else
            fcs_dir = keyvalue & sep_val
          end if
        Case "PAGING_DIR"
          if right$(keyvalue,1) = sep_val Then
            pg_dir = keyvalue
          else
            pg_dir = keyvalue & sep_val
          end if
        Case "LOG_DIR"
          if right$(keyvalue,1) = sep_val Then
            log_dir = keyvalue
          else
            log_dir = keyvalue & sep_val
          end if
        Case "DB_KEY"
          db_key = keyvalue
        Case "DB_TYPE"
          db_type = keyvalue
        Case "SHELL_FILE"
          shell_file = keyvalue
        Case "PM_PATH"
          pm_path = keyvalue

        'section added for PGPT support for RPA customers
        Case "SEND_RPA"
          if right$(keyvalue,1) = sep_val Then
            send_rpa_dir = keyvalue
          else
            send_rpa_dir = keyvalue & sep_val
          end if
        Case "FROM_RPA"
          if right$(keyvalue,1) = sep_val Then
            from_rpa_dir = keyvalue
          else
            from_rpa_dir = keyvalue & sep_val
          end if

        Case Else
'         error_msg "pg.ini line ignored: " + in_line, -1
          error_msg get_sprintf(11107, locale, "", in_line), -1
      End Select
    end if
    Goto next_line
error_in_parse:
    err = -1                            'Clear error trap
'   error_msg "Parsing Error: " + in_line, line_num
    error_msg get_sprintf(11108, locale, "", in_line), line_num
next_line:
    line_num = line_num + 1             'increment line counter
  Wend                                  'repeat for next line
  Close #1                              'close input file

  On Error Goto 0
  Exit Function
missing_file:
  read_ini_file = -400
  err_string = in_file
  On Error Goto 0
End Function

'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' this sub parses the filter string and builds the global variables
'
' Copyright (C) 2001 First Choice Software, Inc. All Rights Reserved
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Sub parse_filter(filter as string)
  Dim pos1        As Integer            'parsing variables
  Dim pos2        As Integer
  Dim keyword     As String
  Dim keyvalue    As String

  pos1 = InStr(filter," ")              'find first space
  if pos1 = 0 then                      'exit if no space
    Exit Sub
  end if
  keyword = Mid$(filter,1,pos1)         'get first word of message
  pos1=pos1+1
  keyvalue = Mid$(filter,pos1)          'get rest of filter string

  If keyword = "INCLUDE " Then
    If keyvalue = "NONE" then
      include_filter = ""
      exclude_filter = response_types
    Else
      If keyvalue = "ALL" then
        include_filter = response_types
        exclude_filter = ""
      Else
        include_filter = keyvalue
        exclude_filter = ""
      End If
    End If
  End If

  If keyword = "EXCLUDE " Then
    If keyvalue = "NONE" then
      include_filter = response_types
      exclude_filter = ""
    Else
      If keyvalue = "ALL" then
        include_filter = ""
        exclude_filter = response_types
      Else
        include_filter = ""
        exclude_filter = keyvalue
      End If
    End If
  End If
End Sub

'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' this sub reads the config_itm table from the database for Paging related records
'
' Copyright (C) 2001 First Choice Software, Inc. All Rights Reserved
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Sub get_config_items()
  Dim cfg_bulk  As New BulkRetrieve     'retrieve area for config items
  Dim cfg_list  As List                 'list for config items
  Dim cfg_rec   As Record               'record for config items
  Dim item      As String               'name of config item
  Dim loopvar   As Integer              'loop index

  max_request  = 10                     'set defaults for config items
  max_response = 10                     'these will be changed by a corresponding
  track_api_request = True              'config_itm if there is one in the table
  track_api_response = "ALL "
  create_api_request_event = True
  create_api_request_focus_act_entry = True
  create_api_response_event = True
  create_api_response_focus_act_entry = True
  create_notify_response_focus_act_entry = True
  track_notify_request = True
  track_notify_response = "ALL "
  use_notify_focus_tag = True

  cfg_bulk.SimpleQuery 0, "config_itm"  'read all of the Paging config_itm records
  cfg_bulk.AppendFilter 0, "name", cbLike, "pg_%"
  cfg_bulk.RetrieveRecords

  Set cfg_list = cfg_bulk.GetRecordList(0)            'get list of items
  For loopvar = 0 to cfg_list.count - 1               'loop through each of the items
    Set cfg_rec = cfg_list.ItemByIndex(loopvar)       'get item record
    item = cfg_rec.GetField("name")
    Select Case item                                  'check each record and update global
      Case "pg_Max_Request"
        max_request = cfg_rec.GetField("i_value")
      Case "pg_Max_Response"
        max_response = cfg_rec.GetField("i_value")
      Case "pg_Customer_ID"
        customer_id = mid$(cfg_rec.GetField("str_value"),1,7)
      Case "pg_Customer_Name"
        customer_name = mid$(cfg_rec.GetField("str_value"),1,8)

      Case "pg_Track_API_Request"                    'API request related items
        If cfg_rec.GetField("i_value") = 0 Then
          track_api_request = False
          create_api_request_event = False
        End If
      Case "pg_Create_API_Request_Event"
        If cfg_rec.GetField("i_value") = 0 Then
          create_api_request_event = False
        End If
      Case "pg_Create_API_Request_Focus_Act_"        'config_itm name field is 32 characters
        If cfg_rec.GetField("i_value") = 0 Then
          create_api_request_focus_act_entry = False
        End If

      Case "pg_Track_NOTIFY_Request"                 'NOTIFY request related items
        If cfg_rec.GetField("i_value") = 0 Then
          track_notify_request = False
        End If
      Case "pg_Use_NOTIFY_Focus_Tag"
        If cfg_rec.GetField("i_value") = 0 Then
          use_notify_focus_tag = False
        End If

      Case "pg_Response_Filter"                      'RESPONSE items
        response_filter = cfg_rec.GetField("str_value")
        parse_filter response_filter
        logmsg 2, "Include: " & include_filter & " Exclude: " & exclude_filter

      Case "pg_Ignore_Filter"                        'IGNORE file types
        ignore_filter = cfg_rec.GetField("str_value")
        logmsg 2, "Ignore: " & ignore_filter

      Case "pg_Track_API_Response"                   'API response related items
        If cfg_rec.GetField("i_value") = 1 Then
          track_api_response = cfg_rec.GetField("str_value")
          If track_api_response = "ALL " or track_api_response = "NONE" then
            rem
          Else
            track_api_response = "ALL "
          End If
        End If
      Case "pg_Create_API_Response_Focus_Act"        'config_itm name field is 32 characters
        If cfg_rec.GetField("i_value") = 0 Then
          create_api_response_focus_act_entry = False
        End If
      Case "pg_Create_API_Response_Event"
        If cfg_rec.GetField("i_value") = 0 Then
          create_api_response_event = False
        End If

      Case "pg_Track_NOTIFY_Response"                'NOTIFY response related items
        If cfg_rec.GetField("i_value") = 1 Then
          track_notify_response = cfg_rec.GetField("str_value")
          If track_notify_response = "ALL " or track_notify_response = "NONE" then
            rem
          Else
            track_notify_response = "ALL "
          End If
        End If
      Case "pg_Create_NOTIFY_Response_Focus_"        'config_itm name field is 32 characters
        If cfg_rec.GetField("i_value") = 0 Then
          create_notify_response_focus_act_entry = False
        End If

      Case Else
'       error_msg "config_itm ignored: " + item, -1
        error_msg get_sprintf(11109, locale, "", item), -1
    End Select
  Next loopvar
End Sub

'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' this sub parses the message looking for case/subcase/employee objid's for relating page
'
' Copyright (C) 2001 First Choice Software, Inc. All Rights Reserved
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Sub parse_msg(req_msg as string)
  Dim pos1        As Integer            'parsing variables
  Dim pos2        As Integer
  Dim keyword     As String
  Dim keyvalue    As String
  Dim searching   As Boolean
  Dim found       As Boolean

  searching = true
  While searching
    found = false                       'set found flag to false
    pos1 = InStr(req_msg," ")           'find first space
    if pos1 = 0 then                    'exit if no space
      exit sub
    end if
    keyword = Mid$(req_msg,1,pos1)      'get first word of message
    pos1=pos1+1
    pos2 = InStr(pos1,req_msg," ")      'find next space
    if pos2 = 0 then                    'if no space, move past end of message
      pos2 = Len(req_msg) + 1
    end if
    keyvalue = Mid$(req_msg,pos1,pos2 - pos1) 'get second word

                                        'if second word is a 9-digit number
    If IsNumeric(keyvalue) and Len(keyvalue) = 9 Then
      If keyword = "CASE " Then
        case_objid = CLng(keyvalue)     'get case objid
        found = true
      End If
      If keyword = "SUBCASE " Then
        subcase_objid = CLng(keyvalue)  'get subcase objid
        found = true
      End If
      If keyword = "EMPLOYEE " Then
        employee_objid = CLng(keyvalue) 'get employee objid
        found = true
      End If
      if found then
        req_msg = Mid$(req_msg,pos2+1)  'remove special keyword and keyvalue
      else
        searching = false               'stop searching if nothing found
      end if
    Else
      searching = False                 'stop searching if second word not a number
    End If
  Wend
End Sub

'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' this sub processes the paging request records
'
' Copyright (C) 2001 First Choice Software, Inc. All Rights Reserved
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Sub process_request(request as String)
  Dim ae_rec      As New Record         'record for act_entry
  Dim bulk_rt     As New BulkRetrieve   'retrieve area for page_requests
  Dim bulk_sv     As New BulkSave       'save area for page_requests
  Dim cas_rec     As Record             'case record area
  Dim emp_rec     As Record             'employee record area
  Dim gbs_rec     As Record             'gbst record area
  Dim pg_rec      As New Record         'record for page_request
  Dim req_length  As String             'request length of message
  Dim req_message As String             'request message
  Dim req_objid   As Long               'request objid
  Dim req_pager   As String             'request device number
  Dim req_type    As String             'request type (API or NOTIFY)
  Dim ret_val     As Integer            'return value
  Dim rt_list     As List               'list of page_requests
  Dim ser_line    As String             'output line for serial file
  Dim sub_rec     As Record             'subcase record area
  Dim tb_rec      As New Record         'record for time_bomb
  Dim usr_rec     As Record             'user record area

  Dim t_bulk      As New BulkRetrieve   'retrieve area for com_template
  Dim t_list      As List               'list of com_template records
  Dim tmplte_rec1 As Record             'record area for com_template
  Dim tmplte_rec2 As Record             'record area for com_template

  pg_rec.RecordType = "page_request"    'define record typea
  ae_rec.RecordType = "act_entry"
  tb_rec.RecordType = "time_bomb"

  case_objid     = 0                    'initialize focus objid's
  subcase_objid  = 0                    '
  employee_objid = 0                    '
  user_objid     = 0                    '
  gbst_objid     = 0                    '

  req_type = mid$(request,1,10)         'get page source type

  If pm_rpa = "rpa" Then
    If req_type = "API       " Then
      req_objid = CLng(mid$(request,11,12))

      bulk_rt.SimpleQuery  0, "page_request"
      bulk_rt.AppendFilter 0, "objid", cbEqual, req_objid
      bulk_rt.RetrieveRecords
      Set rt_list = bulk_rt.GetRecordList(0)
      If rt_list.count > 0 Then
        Set pg_rec = rt_list.ItemByIndex(0)
        req_pager   = pg_rec.GetField("device_num")
        req_message = pg_rec.GetField("message")
        req_length  = Len(req_message)

        logmsg 2, "Paging " & req_pager & " with " & req_message

        '***********************************
        '* BUILD RPA SERIAL INTERFACE FILE *
        '***********************************
        out_file = pg_dir & "0" & format(req_objid,"000000000") & "00PG"
        ser_line = format(customer_name,"!@@@@@@@@")         & _  'custname
                   format(customer_id,"!@@@@@@@")            & _  'custid
                   "0" & format(req_objid,"000000000")       & _  'cref
                   format(req_pager,"!@@@@@@@@@@@@@@@@@@@@") & _  'addr
                                    "                    "   & _  'optional
                   format(req_length,"00000")                & _  'length
                          req_message                          _  'message

        Open out_file For Output As #20                 'Open serial interface file
        Print #20, ser_line
        Close #20

        If track_api_request Then
          If create_api_request_event Then              'create time_bomb record
            logmsg 2, "create time_bomb"

            'get records to use for time_bomb relations
            t_bulk.Clear
            t_bulk.SimpleQuery 0, "com_tmplte"
            t_bulk.AppendFilter 0, "title", cbEqual, "FCS Paging Request API Action"
            t_bulk.SimpleQuery 1, "com_tmplte"
            t_bulk.AppendFilter 1, "title", cbEqual, "FCS Paging Request API"
            t_bulk.RetrieveRecords
            Set t_list = t_bulk.GetRecordList(0)
            If t_list.count > 0 Then                    'event log com template
              Set tmplte_rec1 = t_list.ItemByIndex(0)
            End If
            Set t_list = t_bulk.GetRecordList(1)
            If t_list.count > 0 Then                    'business rule com template
              Set tmplte_rec2 = t_list.ItemByIndex(0)
            End If

            tb_rec.SetField "title",         "FCS Paging Page Request Init"
            tb_rec.SetField "escalate_time", "1/1/1800"
            tb_rec.SetField "end_time",      "1/1/1800"
            tb_rec.SetField "focus_lowid",   pg_rec.GetField("objid")
            tb_rec.SetField "focus_type",    3550
            tb_rec.SetField "time_period",   0
            tb_rec.SetField "flags",         165871618     '(2531 * 65536) + 2
            tb_rec.SetField "left_repeat",   0
            bulk_sv.InsertRecord tb_rec
            bulk_sv.RelateRecordsToId tb_rec, "employee", app.EmployeeObjid, "cmit_creator2employee"
            bulk_sv.RelateRecordsToId tb_rec, "com_tmplte", tmplte_rec1.GetField("objid"), "trckr_info2com_tmplte"
            bulk_sv.RelateRecordsToId tb_rec, "com_tmplte", tmplte_rec2.GetField("objid"), "rule2com_tmplte"
            bulk_sv.Save
            logmsg 2, "created time_bomb " & tb_rec.GetField("objid")
          End If
          If create_api_request_focus_act_entry Then
            logmsg 2, "create act_entry for focus"
            bulk_rt.SetRoot pg_rec                              'set page as root
            bulk_rt.TraverseFromRoot 0, "page_request2employee" 'get employee
            bulk_rt.TraverseFromRoot 1, "page_request2case"     'get case
            bulk_rt.TraverseFromRoot 2, "page_request2subcase"  'get subcase
            bulk_rt.TraverseFromParent 3, "employee2user", 0    'get employee-user record
            bulk_rt.SimpleQuery 4, "gbst_elm"                   'get gbst record
            bulk_rt.AppendFilter 4, "rank", cbEqual, 90220
            bulk_rt.SimpleQuery 5, "user"                       'get default user record
            bulk_rt.AppendFilter 5, "login_name", cbEqual, user_name

            bulk_rt.RetrieveRecords
            Set rt_list = bulk_rt.GetRecordList(0)
            If rt_list.count > 0 Then                   'if employee was found,put in emp_rec
              Set emp_rec = rt_list.ItemByIndex(0)
              employee_objid = emp_rec.GetField("objid")
            End If

            Set rt_list = bulk_rt.GetRecordList(1)
            If rt_list.count > 0 Then                   'if case was found,put in cas_rec
              Set cas_rec = rt_list.ItemByIndex(0)
              case_objid = cas_rec.GetField("objid")
            End If

            Set rt_list = bulk_rt.GetRecordList(2)
            If rt_list.count > 0 Then                   'if subcase was found,put in sub_rec
              Set sub_rec = rt_list.ItemByIndex(0)
              subcase_objid = sub_rec.GetField("objid")
            End If

            Set rt_list = bulk_rt.GetRecordList(3)
            If rt_list.count > 0 Then                   'if user was found,put in usr_rec
              Set usr_rec = rt_list.ItemByIndex(0)
              user_objid = usr_rec.GetField("objid")
            Else
              Set rt_list = bulk_rt.GetRecordList(5)
              If rt_list.count > 0 Then                 'if user wasn't found, use default user for usr_rec
                Set usr_rec = rt_list.ItemByIndex(0)
                user_objid = usr_rec.GetField("objid")
              End If
            End If

            Set rt_list = bulk_rt.GetRecordList(4)
            If rt_list.count > 0 Then                   'if gbst_elm was found,put in gbs_rec
              Set gbs_rec = rt_list.ItemByIndex(0)
              gbst_objid = gbs_rec.GetField("objid")
            End If

            ae_rec.SetField "act_code",   90220
            ae_rec.SetField "entry_time", App.CurrentDate
            ae_rec.SetField "addnl_info", Left$(req_message,255)
            bulk_sv.InsertRecord ae_rec
            bulk_sv.RelateRecords ae_rec, pg_rec, "act_entry2page_request"
            If case_objid > 0 Then
              bulk_sv.RelateRecordsToId ae_rec, "case", case_objid, "act_entry2case"
            End If
            If subcase_objid > 0 Then
              bulk_sv.RelateRecordsToId ae_rec, "subcase", subcase_objid, "act_entry2subcase"
            End If
            If employee_objid > 0 Then
              bulk_sv.RelateRecordsToId ae_rec, "employee", employee_objid, "act_entry2employee"
            End If
            If user_objid > 0 Then
              bulk_sv.RelateRecordsToId ae_rec, "user", user_objid, "act_entry2user"
            End If
            If gbst_objid > 0 Then
              bulk_sv.RelateRecordsToId ae_rec, "gbst_elm", gbst_objid, "entry_name2gbst_elm"
            End If
            bulk_sv.Save
          End If
        Else
          logmsg 2, "delete page_request: " & req_objid
          bulk_sv.DeleteRecord pg_rec
          bulk_sv.Save
        End If
      Else
        logmsg 1, req_objid & " page request record not found"
      End If
    Else
      If req_type = "NOTIFY    " Then
        req_pager   = trim$(mid$(request,11,40))
        req_message = trim$(mid$(request,56))

        If use_notify_focus_tag Then
          parse_msg req_message
          if case_objid > 0 then
            logmsg 2, "related to case " & case_objid
            bulk_rt.SimpleQuery  0, "case"
            bulk_rt.AppendFilter 0, "objid", cbEqual, case_objid
            bulk_rt.RetrieveRecords
            Set rt_list = bulk_rt.GetRecordList(0)
            If rt_list.count > 0 Then
              Set cas_rec = rt_list.ItemByIndex(0)
              case_objid = cas_rec.GetField("objid")
            Else
              case_objid = 0
            End If
          end if
          if subcase_objid > 0 Then
            logmsg 2, "related to subcase " & subcase_objid
            bulk_rt.SimpleQuery  0, "subcase"
            bulk_rt.AppendFilter 0, "objid", cbEqual, subcase_objid
            bulk_rt.RetrieveRecords
            Set rt_list = bulk_rt.GetRecordList(0)
            If rt_list.count > 0 Then
              Set sub_rec = rt_list.ItemByIndex(0)
              subcase_objid = sub_rec.GetField("objid")
            Else
              subcase_objid = 0
            End If
          End If
          If employee_objid > 0 Then
            logmsg 2, "related to employeecase " & employee_objid
            bulk_rt.SimpleQuery  0, "employee"
            bulk_rt.AppendFilter 0, "objid", cbEqual, employee_objid
            bulk_rt.RetrieveRecords
            Set rt_list = bulk_rt.GetRecordList(0)
            If rt_list.count > 0 Then
              Set emp_rec = rt_list.ItemByIndex(0)
              employee_objid = emp_rec.GetField("objid")
            Else
              employee_objid = 0
            End If
          End If
        End If

        pg_rec.SetField "creation_time", App.CurrentDate
        pg_rec.SetField "request_time",  App.CurrentDate
        pg_rec.SetField "type",          1
        pg_rec.SetField "device_num",    req_pager
        pg_rec.SetField "message",       req_message
        pg_rec.SetField "is_closed",     0
        bulk_sv.InsertRecord pg_rec
        If case_objid > 0 Then
          bulk_sv.RelateRecordsToId pg_rec, "case", case_objid, "page_request2case"
        End If
        If subcase_objid > 0 Then
          bulk_sv.RelateRecordsToId pg_rec, "subcase", subcase_objid, "page_request2subcase"
        End If
        If employee_objid > 0 Then
          bulk_sv.RelateRecordsToId pg_rec, "employee", employee_objid, "page_request2employee"
        End If
        bulk_sv.Save

        req_objid = pg_rec.GetField("objid")
        req_length = Len(req_message)

        logmsg 2, "Paging " & req_pager & " with " & req_message & " #" & req_objid

        '***********************************
        '* BUILD RPA SERIAL INTERFACE FILE *
        '***********************************
        out_file = pg_dir & "1" & format(req_objid,"000000000") & "00PG"
        ser_line = format(customer_name,"!@@@@@@@@")         & _  'custname
                   format(customer_id,"!@@@@@@@")            & _  'custid
                   "1" & format(req_objid,"000000000")       & _  'cref
                   format(req_pager,"!@@@@@@@@@@@@@@@@@@@@") & _  'addr
                                    "                    "   & _  'optional
                   format(req_length,"00000")                & _  'length
                          req_message                          _  'message

        Open out_file For Output As #20                 'Open serial interface file
        Print #20, ser_line
        Close #20

        If track_notify_request Then                    'if tracking, update with send time
          logmsg 2, "update page_request request_time field"
          pg_rec.SetField "request_time", App.CurrentDate
          bulk_sv.UpdateRecord pg_rec
        Else                                            'if not tracking, delete page request
          logmsg 2, "delete page_request: " & req_objid
          bulk_sv.DeleteRecord pg_rec
        End If
        bulk_sv.Save                                    'commit update/delete to database
      Else
        logmsg 1, "Invalid rpa page request format"
        Exit Sub
      End If
    End If
  End If

  'section added for PGPT support for RPA customers
  If pm_rpa = "pgpt" Then
    If req_type = "API       " Then
      req_objid = CLng(mid$(request,11,12))

      bulk_rt.SimpleQuery  0, "page_request"
      bulk_rt.AppendFilter 0, "objid", cbEqual, req_objid
      bulk_rt.RetrieveRecords
      Set rt_list = bulk_rt.GetRecordList(0)

      If rt_list.count > 0 Then
        Set pg_rec = rt_list.ItemByIndex(0)

        req_pager   = pg_rec.GetField("device_num")
        req_message = pg_rec.GetField("message")

        req_length  = Len(req_message)

        logmsg 2, "PT Paging " & req_pager & " with " & CStr(req_message)

        '****************************************
        '* BUILD RPA PGPT SERIAL INTERFACE FILE *
        '****************************************
        out_file = send_rpa_dir & "0" & format(req_objid,"000000000") & "PGPT"
        Open out_file For Output As #20                 'Open serial interface file

        If win_type Then
          Print #20, "VER 2.00"
          Print #20, "TYPE PG"
          Print #20, "CREF " & "0" & format(req_objid,"000000000")
          Print #20, "NAME " & customer_name
          Print #20, "ID " & customer_id
          Print #20, "ADDR " & req_pager
          Print #20, "DATA " & req_message
         'Print #20, "LIFE "                              ' Other optional fields
         'Print #20, "NET "
         'Print #20, "MAXSZ "
         'Print #20, "MAXSEGS "
         'Print #20, "USERID "
         'Print #20, "PRIORITY "
         'Print #20, "SKILLS "
         'Print #20, "RESP_LIST "
         'Print #20, "LEVEL "
         'Print #20, "CONFIRM "
        Else
          Print #20, "VER 2.00" & Chr(13)
          Print #20, "TYPE PG" & Chr(13)
          Print #20, "CREF " & "0" & format(req_objid,"000000000") & Chr(13)
          Print #20, "NAME " & customer_name & Chr(13)
          Print #20, "ID " & customer_id & Chr(13)
          Print #20, "ADDR " & req_pager & Chr(13)
          Print #20, "DATA " & req_message & Chr(13)
         'Print #20, "LIFE "                              ' Other optional fields
         'Print #20, "NET "
         'Print #20, "MAXSZ "
         'Print #20, "MAXSEGS "
         'Print #20, "USERID "
         'Print #20, "PRIORITY "
         'Print #20, "SKILLS "
         'Print #20, "RESP_LIST "
         'Print #20, "LEVEL "
         'Print #20, "CONFIRM "
        End If

        Close #20

        If track_api_request Then
          If create_api_request_event Then              'create time_bomb record
            logmsg 2, "create time_bomb"

            'get records to use for time_bomb relations
            t_bulk.Clear
            t_bulk.SimpleQuery 0, "com_tmplte"
            t_bulk.AppendFilter 0, "title", cbEqual, "FCS Paging Request API Action"
            t_bulk.SimpleQuery 1, "com_tmplte"
            t_bulk.AppendFilter 1, "title", cbEqual, "FCS Paging Request API"
            t_bulk.RetrieveRecords
            Set t_list = t_bulk.GetRecordList(0)
            If t_list.count > 0 Then                    'event log com template
              Set tmplte_rec1 = t_list.ItemByIndex(0)
            End If
            Set t_list = t_bulk.GetRecordList(1)
            If t_list.count > 0 Then                    'business rule com template
              Set tmplte_rec2 = t_list.ItemByIndex(0)
            End If

            tb_rec.SetField "title",         "FCS Paging Page Request Init"
            tb_rec.SetField "escalate_time", "1/1/1800"
            tb_rec.SetField "end_time",      "1/1/1800"
            tb_rec.SetField "focus_lowid",   pg_rec.GetField("objid")
            tb_rec.SetField "focus_type",    3550
            tb_rec.SetField "time_period",   0
            tb_rec.SetField "flags",         165871618     '(2531 * 65536) + 2
            tb_rec.SetField "left_repeat",   0
            bulk_sv.InsertRecord tb_rec
            bulk_sv.RelateRecordsToId tb_rec, "employee", app.EmployeeObjid, "cmit_creator2employee"
            bulk_sv.RelateRecordsToId tb_rec, "com_tmplte", tmplte_rec1.GetField("objid"), "trckr_info2com_tmplte"
            bulk_sv.RelateRecordsToId tb_rec, "com_tmplte", tmplte_rec2.GetField("objid"), "rule2com_tmplte"
            bulk_sv.Save
            logmsg 2, "created time_bomb " & tb_rec.GetField("objid")
          End If
          If create_api_request_focus_act_entry Then
            logmsg 2, "create act_entry for focus"
            bulk_rt.SetRoot pg_rec                              'set page as root
            bulk_rt.TraverseFromRoot 0, "page_request2employee" 'get employee
            bulk_rt.TraverseFromRoot 1, "page_request2case"     'get case
            bulk_rt.TraverseFromRoot 2, "page_request2subcase"  'get subcase
            bulk_rt.TraverseFromParent 3, "employee2user", 0    'get employee-user record
            bulk_rt.SimpleQuery 4, "gbst_elm"                   'get gbst record
            bulk_rt.AppendFilter 4, "rank", cbEqual, 90220
            bulk_rt.SimpleQuery 5, "user"                       'get default user record
            bulk_rt.AppendFilter 5, "login_name", cbEqual, user_name

            bulk_rt.RetrieveRecords
            Set rt_list = bulk_rt.GetRecordList(0)
            If rt_list.count > 0 Then                   'if employee was found,put in emp_rec
              Set emp_rec = rt_list.ItemByIndex(0)
              employee_objid = emp_rec.GetField("objid")
            End If

            Set rt_list = bulk_rt.GetRecordList(1)
            If rt_list.count > 0 Then                   'if case was found,put in cas_rec
              Set cas_rec = rt_list.ItemByIndex(0)
              case_objid = cas_rec.GetField("objid")
            End If

            Set rt_list = bulk_rt.GetRecordList(2)
            If rt_list.count > 0 Then                   'if subcase was found,put in sub_rec
              Set sub_rec = rt_list.ItemByIndex(0)
              subcase_objid = sub_rec.GetField("objid")
            End If

            Set rt_list = bulk_rt.GetRecordList(3)
            If rt_list.count > 0 Then                   'if user was found,put in usr_rec
              Set usr_rec = rt_list.ItemByIndex(0)
              user_objid = usr_rec.GetField("objid")
            Else
              Set rt_list = bulk_rt.GetRecordList(5)
              If rt_list.count > 0 Then                 'if user wasn't found, use default user for usr_rec
                Set usr_rec = rt_list.ItemByIndex(0)
                user_objid = usr_rec.GetField("objid")
              End If
            End If

            Set rt_list = bulk_rt.GetRecordList(4)
            If rt_list.count > 0 Then                   'if gbst_elm was found,put in gbs_rec
              Set gbs_rec = rt_list.ItemByIndex(0)
              gbst_objid = gbs_rec.GetField("objid")
            End If

            ae_rec.SetField "act_code",   90220
            ae_rec.SetField "entry_time", App.CurrentDate
            ae_rec.SetField "addnl_info", Left$(req_message,255)
            bulk_sv.InsertRecord ae_rec
            bulk_sv.RelateRecords ae_rec, pg_rec, "act_entry2page_request"
            If case_objid > 0 Then
              bulk_sv.RelateRecordsToId ae_rec, "case", case_objid, "act_entry2case"
            End If
            If subcase_objid > 0 Then
              bulk_sv.RelateRecordsToId ae_rec, "subcase", subcase_objid, "act_entry2subcase"
            End If
            If employee_objid > 0 Then
              bulk_sv.RelateRecordsToId ae_rec, "employee", employee_objid, "act_entry2employee"
            End If
            If user_objid > 0 Then
              bulk_sv.RelateRecordsToId ae_rec, "user", user_objid, "act_entry2user"
            End If
            If gbst_objid > 0 Then
              bulk_sv.RelateRecordsToId ae_rec, "gbst_elm", gbst_objid, "entry_name2gbst_elm"
            End If
            bulk_sv.Save
          End If
        Else
          logmsg 2, "delete page_request: " & req_objid
          bulk_sv.DeleteRecord pg_rec
          bulk_sv.Save
        End If
      Else
        logmsg 1, req_objid & " page request record not found"
      End If
    Else
      If req_type = "NOTIFY    " Then
        req_pager   = trim$(mid$(request,11,40))
        req_message = trim$(mid$(request,56))

        If use_notify_focus_tag Then
          parse_msg req_message
          if case_objid > 0 then
            logmsg 2, "related to case " & case_objid
            bulk_rt.SimpleQuery  0, "case"
            bulk_rt.AppendFilter 0, "objid", cbEqual, case_objid
            bulk_rt.RetrieveRecords
            Set rt_list = bulk_rt.GetRecordList(0)
            If rt_list.count > 0 Then
              Set cas_rec = rt_list.ItemByIndex(0)
              case_objid = cas_rec.GetField("objid")
            Else
              case_objid = 0
            End If
          end if
          if subcase_objid > 0 Then
            logmsg 2, "related to subcase " & subcase_objid
            bulk_rt.SimpleQuery  0, "subcase"
            bulk_rt.AppendFilter 0, "objid", cbEqual, subcase_objid
            bulk_rt.RetrieveRecords
            Set rt_list = bulk_rt.GetRecordList(0)
            If rt_list.count > 0 Then
              Set sub_rec = rt_list.ItemByIndex(0)
              subcase_objid = sub_rec.GetField("objid")
            Else
              subcase_objid = 0
            End If
          End If
          If employee_objid > 0 Then
            logmsg 2, "related to employeecase " & employee_objid
            bulk_rt.SimpleQuery  0, "employee"
            bulk_rt.AppendFilter 0, "objid", cbEqual, employee_objid
            bulk_rt.RetrieveRecords
            Set rt_list = bulk_rt.GetRecordList(0)
            If rt_list.count > 0 Then
              Set emp_rec = rt_list.ItemByIndex(0)
              employee_objid = emp_rec.GetField("objid")
            Else
              employee_objid = 0
            End If
          End If
        End If

        pg_rec.SetField "creation_time", App.CurrentDate
        pg_rec.SetField "request_time",  App.CurrentDate
        pg_rec.SetField "type",          1
        pg_rec.SetField "device_num",    req_pager
        pg_rec.SetField "message",       req_message
        pg_rec.SetField "is_closed",     0
        bulk_sv.InsertRecord pg_rec
        If case_objid > 0 Then
          bulk_sv.RelateRecordsToId pg_rec, "case", case_objid, "page_request2case"
        End If
        If subcase_objid > 0 Then
          bulk_sv.RelateRecordsToId pg_rec, "subcase", subcase_objid, "page_request2subcase"
        End If
        If employee_objid > 0 Then
          bulk_sv.RelateRecordsToId pg_rec, "employee", employee_objid, "page_request2employee"
        End If
        bulk_sv.Save

        req_objid = pg_rec.GetField("objid")
        req_length = Len(req_message)

        logmsg 2, "PT Paging " & req_pager & " with " & CStr(req_message)

        '****************************************
        '* BUILD RPA PGPT SERIAL INTERFACE FILE *
        '****************************************
        out_file = send_rpa_dir & "1" & format(req_objid,"000000000") & "PGPT"
        Open out_file For Output As #20                 'Open serial interface file

        If win_type Then
          Print #20, "VER 2.00"
          Print #20, "TYPE PG"
          Print #20, "CREF " & "1" & format(req_objid,"000000000")
          Print #20, "NAME " & customer_name
          Print #20, "ID " & customer_id
          Print #20, "ADDR " & req_pager
          Print #20, "DATA " & req_message
         'Print #20, "LIFE "                              ' Other optional fields
         'Print #20, "NET "
         'Print #20, "MAXSZ "
         'Print #20, "MAXSEGS "
         'Print #20, "USERID "
         'Print #20, "PRIORITY "
         'Print #20, "SKILLS "
         'Print #20, "RESP_LIST "
         'Print #20, "LEVEL "
         'Print #20, "CONFIRM "
        Else
          Print #20, "VER 2.00" & Chr(13)
          Print #20, "TYPE PG" & Chr(13)
          Print #20, "CREF " & "1" & format(req_objid,"000000000") & Chr(13)
          Print #20, "NAME " & customer_name & Chr(13)
          Print #20, "ID " & customer_id & Chr(13)
          Print #20, "ADDR " & req_pager & Chr(13)
          Print #20, "DATA " & req_message & Chr(13)
         'Print #20, "LIFE "                              ' Other optional fields
         'Print #20, "NET "
         'Print #20, "MAXSZ "
         'Print #20, "MAXSEGS "
         'Print #20, "USERID "
         'Print #20, "PRIORITY "
         'Print #20, "SKILLS "
         'Print #20, "RESP_LIST "
         'Print #20, "LEVEL "
         'Print #20, "CONFIRM "
        End If
        Close #20

        If track_notify_request Then                    'if tracking, update with send time
          logmsg 2, "update page_request request_time field"
          pg_rec.SetField "request_time", App.CurrentDate
          bulk_sv.UpdateRecord pg_rec
        Else                                            'if not tracking, delete page request
          logmsg 2, "delete page_request: " & req_objid
          bulk_sv.DeleteRecord pg_rec
        End If
        bulk_sv.Save                                    'commit update/delete to database
      Else
        logmsg 1, "Invalid rpa page request format"
        Exit Sub
      End If
    End If
  End If

  If pm_rpa = "pm" Then
    If req_type = "API       " Then
      req_objid   = CLng(mid$(request,11,9))

      bulk_rt.SimpleQuery  0, "page_request"
      bulk_rt.AppendFilter 0, "objid", cbEqual, req_objid
      bulk_rt.RetrieveRecords
      Set rt_list = bulk_rt.GetRecordList(0)
      If rt_list.count > 0 Then
        Set pg_rec = rt_list.ItemByIndex(0)
        req_pager   = pg_rec.GetField("device_num")
        req_message = pg_rec.GetField("message")
        req_length  = Len(req_message)

        logmsg 2, "PAGEMATE API Paging " & req_pager & " with " & """" & req_message & """"

        'shell out to the pagemate process
        If InStr(pm_path,"pagecmd") > 0 Then
          ser_line = pm_path & " -s " & req_pager & " " & """" & req_message & """"
        Else
          ser_line = pm_path & " SEND " & req_pager & " " & """" & req_message & """"
        End If
        ret_val = Shell(ser_line)

        If track_api_request Then
          If create_api_request_event Then              'create time_bomb record
            logmsg 2, "create time_bomb"

            'get records to use for time_bomb relations
            t_bulk.Clear
            t_bulk.SimpleQuery 0, "com_tmplte"
            t_bulk.AppendFilter 0, "title", cbEqual, "FCS Paging Request API Action"
            t_bulk.SimpleQuery 1, "com_tmplte"
            t_bulk.AppendFilter 1, "title", cbEqual, "FCS Paging Request API"
            t_bulk.RetrieveRecords
            Set t_list = t_bulk.GetRecordList(0)
            If t_list.count > 0 Then                    'event log com template
              Set tmplte_rec1 = t_list.ItemByIndex(0)
            End If
            Set t_list = t_bulk.GetRecordList(1)
            If t_list.count > 0 Then                    'business rule com template
              Set tmplte_rec2 = t_list.ItemByIndex(0)
            End If

            tb_rec.SetField "title",         "FCS Paging Page Request Init"
            tb_rec.SetField "escalate_time", "1/1/1800"
            tb_rec.SetField "end_time",      "1/1/1800"
            tb_rec.SetField "focus_lowid",   pg_rec.GetField("objid")
            tb_rec.SetField "focus_type",    3550
            tb_rec.SetField "time_period",   0
            tb_rec.SetField "flags",         165871618     '(2531 * 65536) + 2
            tb_rec.SetField "left_repeat",   0
            bulk_sv.InsertRecord tb_rec
            bulk_sv.RelateRecordsToId tb_rec, "employee", app.EmployeeObjid, "cmit_creator2employee"
            bulk_sv.RelateRecordsToId tb_rec, "com_tmplte", tmplte_rec1.GetField("objid"), "trckr_info2com_tmplte"
            bulk_sv.RelateRecordsToId tb_rec, "com_tmplte", tmplte_rec2.GetField("objid"), "rule2com_tmplte"
            bulk_sv.Save
            logmsg 2, "created time_bomb " & tb_rec.GetField("objid")
          End If
          If create_api_request_focus_act_entry Then
            logmsg 2, "create act_entry for focus"
            bulk_rt.SetRoot pg_rec                              'set page as root
            bulk_rt.TraverseFromRoot 0, "page_request2employee" 'get employee
            bulk_rt.TraverseFromRoot 1, "page_request2case"     'get case
            bulk_rt.TraverseFromRoot 2, "page_request2subcase"  'get subcase
            bulk_rt.TraverseFromParent 3, "employee2user", 0    'get employee-user record
            bulk_rt.SimpleQuery 4, "gbst_elm"                   'get gbst record
            bulk_rt.AppendFilter 4, "rank", cbEqual, 90220
            bulk_rt.SimpleQuery 5, "user"                       'get default user record
            bulk_rt.AppendFilter 5, "login_name", cbEqual, user_name

            bulk_rt.RetrieveRecords
            Set rt_list = bulk_rt.GetRecordList(0)
            If rt_list.count > 0 Then                   'if employee was found,put in emp_rec
              Set emp_rec = rt_list.ItemByIndex(0)
              employee_objid = emp_rec.GetField("objid")
            End If

            Set rt_list = bulk_rt.GetRecordList(1)
            If rt_list.count > 0 Then                   'if case was found,put in cas_rec
              Set cas_rec = rt_list.ItemByIndex(0)
              case_objid = cas_rec.GetField("objid")
            End If

            Set rt_list = bulk_rt.GetRecordList(2)
            If rt_list.count > 0 Then                   'if subcase was found,put in sub_rec
              Set sub_rec = rt_list.ItemByIndex(0)
              subcase_objid = sub_rec.GetField("objid")
            End If

            Set rt_list = bulk_rt.GetRecordList(3)
            If rt_list.count > 0 Then                   'if user was found,put in usr_rec
              Set usr_rec = rt_list.ItemByIndex(0)
              user_objid = usr_rec.GetField("objid")
            Else
              Set rt_list = bulk_rt.GetRecordList(5)
              If rt_list.count > 0 Then                 'if user wasn't found, use default user for usr_rec
                Set usr_rec = rt_list.ItemByIndex(0)
                user_objid = usr_rec.GetField("objid")
              End If
            End If

            Set rt_list = bulk_rt.GetRecordList(4)
            If rt_list.count > 0 Then                   'if gbst_elm was found,put in gbs_rec
              Set gbs_rec = rt_list.ItemByIndex(0)
              gbst_objid = gbs_rec.GetField("objid")
            End If

            ae_rec.SetField "act_code",   90220
            ae_rec.SetField "entry_time", App.CurrentDate
            ae_rec.SetField "addnl_info", Left$(req_message,255)
            bulk_sv.InsertRecord ae_rec
            bulk_sv.RelateRecords ae_rec, pg_rec, "act_entry2page_request"
            If case_objid > 0 Then
              bulk_sv.RelateRecordsToId ae_rec, "case", case_objid, "act_entry2case"
            End If
            If subcase_objid > 0 Then
              bulk_sv.RelateRecordsToId ae_rec, "subcase", subcase_objid, "act_entry2subcase"
            End If
            If employee_objid > 0 Then
              bulk_sv.RelateRecordsToId ae_rec, "employee", employee_objid, "act_entry2employee"
            End If
            If user_objid > 0 Then
              bulk_sv.RelateRecordsToId ae_rec, "user", user_objid, "act_entry2user"
            End If
            If gbst_objid > 0 Then
              bulk_sv.RelateRecordsToId ae_rec, "gbst_elm", gbst_objid, "entry_name2gbst_elm"
            End If
            bulk_sv.Save
          End If
        Else
          logmsg 2, "delete page_request: " & req_objid
          bulk_sv.DeleteRecord pg_rec
          bulk_sv.Save
        End If
      Else
        If req_pager <> "" and req_message <> "" Then
          logmsg 2, "PAGEMATE Direct Paging " & req_pager & " with " & req_message

          'shell out to the pagemate process
          If InStr(pm_path,"pagecmd") > 0 Then
            ser_line = pm_path & " -s " & req_pager & " " & """" & req_message & """"
          Else
            ser_line = pm_path & " SEND " & req_pager & " " & """" & req_message & """"
          End If
          ret_val = Shell(ser_line)

        Else
          logmsg 1, req_objid & " page request record not found"
        End If
      End If
    Else
      If req_type = "NOTIFY    " Then
        req_pager   = trim$(mid$(request,11,40))
        req_message = trim$(mid$(request,56))

        If use_notify_focus_tag Then
          parse_msg req_message
          if case_objid > 0 then
            logmsg 2, "related to case " & case_objid
            bulk_rt.SimpleQuery  0, "case"
            bulk_rt.AppendFilter 0, "objid", cbEqual, case_objid
            bulk_rt.RetrieveRecords
            Set rt_list = bulk_rt.GetRecordList(0)
            If rt_list.count > 0 Then
              Set cas_rec = rt_list.ItemByIndex(0)
              case_objid = cas_rec.GetField("objid")
            Else
              case_objid = 0
            End If
          end if
          if subcase_objid > 0 Then
            logmsg 2, "related to subcase " & subcase_objid
            bulk_rt.SimpleQuery  0, "subcase"
            bulk_rt.AppendFilter 0, "objid", cbEqual, subcase_objid
            bulk_rt.RetrieveRecords
            Set rt_list = bulk_rt.GetRecordList(0)
            If rt_list.count > 0 Then
              Set sub_rec = rt_list.ItemByIndex(0)
              subcase_objid = sub_rec.GetField("objid")
            Else
              subcase_objid = 0
            End If
          End If
          If employee_objid > 0 Then
            logmsg 2, "related to employeecase " & employee_objid
            bulk_rt.SimpleQuery  0, "employee"
            bulk_rt.AppendFilter 0, "objid", cbEqual, employee_objid
            bulk_rt.RetrieveRecords
            Set rt_list = bulk_rt.GetRecordList(0)
            If rt_list.count > 0 Then
              Set emp_rec = rt_list.ItemByIndex(0)
              employee_objid = emp_rec.GetField("objid")
            Else
              employee_objid = 0
            End If
          End If
        End If

        pg_rec.SetField "creation_time", App.CurrentDate
        pg_rec.SetField "request_time",  App.CurrentDate
        pg_rec.SetField "type",          1
        pg_rec.SetField "device_num",    req_pager
        pg_rec.SetField "message",       req_message
        pg_rec.SetField "is_closed",     0
        bulk_sv.InsertRecord pg_rec
        If case_objid > 0 Then
          bulk_sv.RelateRecordsToId pg_rec, "case", case_objid, "page_request2case"
        End If
        If subcase_objid > 0 Then
          bulk_sv.RelateRecordsToId pg_rec, "subcase", subcase_objid, "page_request2subcase"
        End If
        If employee_objid > 0 Then
          bulk_sv.RelateRecordsToId pg_rec, "employee", employee_objid, "page_request2employee"
        End If
        bulk_sv.Save

        req_objid = pg_rec.GetField("objid")
        req_length = Len(req_message)

        '***********************************
        '* Send PageMate Message           *
        '***********************************
        logmsg 2, "PAGEMATE NOTIFY Paging " & req_pager & " with " & """" & req_message & """"

        'shell out to the pagemate process
        If InStr(pm_path,"pagecmd") > 0 Then
          ser_line = pm_path & " -s " & req_pager & " " & """" & req_message & """"
        Else
          ser_line = pm_path & " SEND " & req_pager & " " & """" & req_message & """"
        End If
        ret_val = Shell(ser_line)

        If track_notify_request Then                    'if tracking, update with send time
          logmsg 2, "update page_request request_time field"
          pg_rec.SetField "request_time", App.CurrentDate
          bulk_sv.UpdateRecord pg_rec
        Else                                            'if not tracking, delete page request
          logmsg 2, "delete page_request: " & req_objid
          bulk_sv.DeleteRecord pg_rec
        End If
        bulk_sv.Save                                    'commit update/delete to database

      Else
        logmsg 1, "Invalid page request format"
        Exit Sub
      End If
    End If
  End If
End Sub

'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' this sub processes the paging response records
'
' Copyright (C) 2001 First Choice Software, Inc. All Rights Reserved
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Sub process_response(response as String, response_code As String, _
                     response_time As Date, resp_a_n As Integer)

  Dim ae_rec      As New Record         'record for act_entry
  Dim bulk_rt     As New BulkRetrieve   'retrieve area for page_requests
  Dim bulk_sv     As New BulkSave       'save area for page_requests
  Dim cas_rec     As Record             'case record area
  Dim emp_rec     As Record             'employee record area
  Dim gbs_rec     As Record             'gbst record area
  Dim pg_rec      As New Record         'record for page_request
  Dim pr_rec      As New Record         'record for page_response
  Dim req_length  As String             'request length of message
  Dim req_message As String             'request message
  Dim req_objid   As Long               'request objid
  Dim req_pager   As String             'request device number
  Dim req_type    As String             'request type (API or NOTIFY)
  Dim rt_list     As List               'list of page_requests
  Dim ser_line    As String             'output line for serial file
  Dim sub_rec     As Record             'subcase record area
  Dim tb_rec      As New Record         'record for time_bomb
  Dim usr_rec     As Record             'user record area
  Dim save_flag   As Boolean            'indicate if save needs to be done

  Dim t_bulk      As New BulkRetrieve   'retrieve area for com_template
  Dim t_list      As List               'list of com_template records
  Dim tmplte_rec1 As Record             'record area for com_template
  Dim tmplte_rec2 As Record             'record area for com_template

  Dim dlyr        As Integer            'delivery year
  Dim dlmon       As Integer            'delivery month
  Dim dlday       As Integer            'delivery day
  Dim dlhr        As Integer            'delivery hour
  Dim dlmin       As Integer            'delivery minute
  Dim dl_date     As Date

  pg_rec.RecordType = "page_request"    'define record types
  pr_rec.RecordType = "page_response"
  ae_rec.RecordType = "act_entry"
  tb_rec.RecordType = "time_bomb"

  case_objid     = 0                    'initialize focus objid's
  subcase_objid  = 0                    '
  employee_objid = 0                    '
  user_objid     = 0                    '
  gbst_objid     = 0                    '

  Set bulk_sv = New BulkSave

  If response_code = "PA" Then
    logmsg 2, "getting objid for " & response
    req_objid = Mid(FileParse$(response,3),2,9)
    response = ""
  Else
    If IsNumeric(mid$(response,5,9)) Then
      req_objid = CLng(mid$(response,5,9))            'get page request objid
    Else
      logmsg 2, "Invalid cref in response text"
    End If
  End If

  If (resp_a_n = 0 and track_api_request) or _        'update request record
     (resp_a_n = 1 and track_notify_request) then     'if tracking requests
      bulk_rt.SimpleQuery  0, "page_request"          'get page_request record
      bulk_rt.AppendFilter 0, "objid", cbEqual, req_objid
      bulk_rt.RetrieveRecords
      Set rt_list = bulk_rt.GetRecordList(0)
      If rt_list.count > 0 Then
        Set pg_rec = rt_list.ItemByIndex(0)           'load record and update fields
        pg_rec.SetField "last_response_code", response_code
        logmsg 2, CStr(response_time)
        pg_rec.SetField "last_response_date", format(response_time, "c")
        bulk_sv.UpdateRecord pg_rec                   'put record into bulk-save
        save_flag = True                              'set save trigger
      Else
        logmsg 2, "page request record not found"
        Exit Sub
      End If
  Else
      Exit Sub
  End If
  logmsg 2, "in response code 2"

  bulk_rt.SetRoot pg_rec                              'set page as root
  bulk_rt.TraverseFromRoot 0, "page_request2employee" 'get employee
  bulk_rt.TraverseFromRoot 1, "page_request2case"     'get case
  bulk_rt.TraverseFromRoot 2, "page_request2subcase"  'get subcase
  bulk_rt.TraverseFromParent 3, "employee2user", 0    'get employee-user record
  bulk_rt.SimpleQuery 4, "gbst_elm"                   'get gbst record
  bulk_rt.AppendFilter 4, "rank", cbEqual, 90221
  bulk_rt.SimpleQuery 5, "user"                       'get default user record
  bulk_rt.AppendFilter 5, "login_name", cbEqual, user_name
  bulk_rt.RetrieveRecords

  If (resp_a_n = 0 and track_api_response = "ALL ") or _      'build response record
     (resp_a_n = 1 and track_notify_response = "ALL ") then   'if tracking all responses
      pr_rec.SetField "creation_time", App.CurrentDate
      pr_rec.SetField "response_time", format(response_time, "c")
      pr_rec.SetField "response_code", response_code
      If InStr("RJ TO TN",response_code) <> 0 Then            'removed ND from here on 9-22-99
        pr_rec.SetField "response_reason", mid$(response,14,2)
      Else
        If InStr("NC ND",response_code) <> 0 Then             'moved ND here on 9-22-99
          pr_rec.SetField "response_reason", mid$(response,118,2)
        Else
          pr_rec.SetField "response_reason", ""
        End If
      End If
      If InStr("RJ TO TN",response_code) <> 0 Then
        pr_rec.SetField "response_addr", mid$(response,16,20)
      Else
        pr_rec.SetField "response_addr", ""
      End If

      If InStr("DL",response_code) <> 0 or _
         InStr("CF",response_code) <> 0 Then
         dlyr  = CInt(DatePart("yyyy", App.CurrentDate))
        if len(trim$(mid$(response,119,2))) > 0 then
          dlmon = CInt(mid$(response,119,2))
          dlday = CInt(mid$(response,122,2))
          dlhr  = CInt(mid$(response,125,2))
          dlmin = CInt(mid$(response,128,2))
          dl_date = DateSerial(dlyr, dlmon, dlday) + TimeSerial(dlhr, dlmin, 0)
        else
          dl_date = app.currentdate
        end if
        pr_rec.SetField "delivery_time", Format(CStr(dl_date),"c")
      Else
        pr_rec.SetField "delivery_time", ""
      End If
      If InStr("CF",response_code) <> 0 Then
        pr_rec.SetField "confirmation", mid$(response,136)
      Else
        pr_rec.SetField "confirmation", ""
      End If
      bulk_sv.InsertRecord pr_rec                     'put in bulk_save and add relation
      bulk_sv.RelateRecordsToId pr_rec, "page_request", req_objid, "page_response2page_request"
      save_flag = True                                'set save trigger
      logmsg 2, "page response record created"
  End If

'************
  If (resp_a_n = 0 and create_api_response_focus_act_entry) or _    'build act_entry record
     (resp_a_n = 1 and create_notify_response_focus_act_entry) then 'if required
      logmsg 2, "create act_entry for focus from response"

      Set rt_list = bulk_rt.GetRecordList(0)
      If rt_list.count > 0 Then                   'if employee was found,put in emp_rec
        Set emp_rec = rt_list.ItemByIndex(0)
        employee_objid = emp_rec.GetField("objid")
      End If

      Set rt_list = bulk_rt.GetRecordList(1)
      If rt_list.count > 0 Then                   'if case was found,put in cas_rec
        Set cas_rec = rt_list.ItemByIndex(0)
        case_objid = cas_rec.GetField("objid")
      End If

      Set rt_list = bulk_rt.GetRecordList(2)
      If rt_list.count > 0 Then                   'if subcase was found,put in sub_rec
        Set sub_rec = rt_list.ItemByIndex(0)
        subcase_objid = sub_rec.GetField("objid")
      End If

      Set rt_list = bulk_rt.GetRecordList(3)
      If rt_list.count > 0 Then                   'if user was found,put in usr_rec
        Set usr_rec = rt_list.ItemByIndex(0)
        user_objid = usr_rec.GetField("objid")
      Else
        Set rt_list = bulk_rt.GetRecordList(5)
        If rt_list.count > 0 Then                 'if user wasn't found, use default user for usr_rec
          Set usr_rec = rt_list.ItemByIndex(0)
          user_objid = usr_rec.GetField("objid")
        End If
      End If

      Set rt_list = bulk_rt.GetRecordList(4)
      If rt_list.count > 0 Then                   'if gbst_elm was found,put in gbs_rec
        Set gbs_rec = rt_list.ItemByIndex(0)
        gbst_objid = gbs_rec.GetField("objid")
      End If

      ae_rec.SetField "act_code",   90221
      ae_rec.SetField "entry_time", App.CurrentDate
      ae_rec.SetField "addnl_info", "Code:"         & response_code       & " " & _
                                    "Reason:"       & mid$(response,14,2) & " " & _
                                    "Confirmation:" & mid$(response,119,11)
      bulk_sv.InsertRecord ae_rec
      bulk_sv.RelateRecords ae_rec, pg_rec, "act_entry2page_request"
      If case_objid > 0 Then
        bulk_sv.RelateRecordsToId ae_rec, "case", case_objid, "act_entry2case"
      End If
      If subcase_objid > 0 Then
        bulk_sv.RelateRecordsToId ae_rec, "subcase", subcase_objid, "act_entry2subcase"
      End If
      If employee_objid > 0 Then
        bulk_sv.RelateRecordsToId ae_rec, "employee", employee_objid, "act_entry2employee"
      End If
      If user_objid > 0 Then
        bulk_sv.RelateRecordsToId ae_rec, "user", user_objid, "act_entry2user"
      End If
      If gbst_objid > 0 Then
        bulk_sv.RelateRecordsToId ae_rec, "gbst_elm", gbst_objid, "entry_name2gbst_elm"
      End If
      save_flag = True                                'set save trigger
  End If
  If save_flag Then
    bulk_sv.Save
    save_flag = False                                 'clear save trigger
  End If

  Set bulk_sv = New BulkSave
  If (resp_a_n = 0 and create_api_response_event) Then     'create time_bomb record
      logmsg 2, "create time_bomb for API response"

      Set rt_list = bulk_rt.GetRecordList(0)
      If rt_list.count > 0 Then                   'if employee was found,put in emp_rec
        Set emp_rec = rt_list.ItemByIndex(0)
        employee_objid = emp_rec.GetField("objid")
      End If

      'get records to use for time_bomb relations
      t_bulk.Clear
      t_bulk.SimpleQuery 0, "com_tmplte"
      t_bulk.AppendFilter 0, "title", cbEqual, "FCS Paging Response Action"
      t_bulk.SimpleQuery 1, "com_tmplte"
      t_bulk.AppendFilter 1, "title", cbEqual, "FCS Paging Response"
      t_bulk.RetrieveRecords
      Set t_list = t_bulk.GetRecordList(0)
      If t_list.count > 0 Then                        'event log com template
        Set tmplte_rec1 = t_list.ItemByIndex(0)
      End If
      Set t_list = t_bulk.GetRecordList(1)
      If t_list.count > 0 Then                        'business rule com template
        Set tmplte_rec2 = t_list.ItemByIndex(0)
      End If

      logmsg 2, "time_bomb: cmit_creator2employee = " & employee_objid
      logmsg 2, "time_bomb: trckr_info2com_tmplte = " & tmplte_rec1.GetField("objid")
      logmsg 2, "time_bomb: rule2com_tmplte = " & tmplte_rec2.GetField("objid")

      tb_rec.SetField "title",         "FCS Paging Page Response"
      tb_rec.SetField "escalate_time", "1/1/1800"
      tb_rec.SetField "end_time",      App.CurrentDate
      tb_rec.SetField "focus_lowid",   pr_rec.GetField("objid")
      tb_rec.SetField "focus_type",    3551
      tb_rec.SetField "time_period",   0
      tb_rec.SetField "flags",         165937154      '(2532 * 65536) + 2
      tb_rec.SetField "left_repeat",   0
      bulk_sv.InsertRecord tb_rec
      if employee_objid > 0 then
        bulk_sv.RelateRecordsToId tb_rec, "employee", employee_objid, "cmit_creator2employee"
      else
        bulk_sv.RelateRecordsToId tb_rec, "employee", app.EmployeeObjid, "cmit_creator2employee"
      end if
      bulk_sv.RelateRecordsToId tb_rec, "com_tmplte", tmplte_rec1.GetField("objid"), "trckr_info2com_tmplte"
      bulk_sv.RelateRecordsToId tb_rec, "com_tmplte", tmplte_rec2.GetField("objid"), "rule2com_tmplte"
      save_flag = True                                'set save trigger
  End If

'************

  If save_flag Then
    bulk_sv.Save
  End If
End Sub

'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' this function converts the ISO date into a date field
'
' Copyright (C) 2001 First Choice Software, Inc. All Rights Reserved
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Function convert_date(input_item As String) As Date
  Dim dlyr        As Integer            'delivery year
  Dim dlmon       As Integer            'delivery month
  Dim dlday       As Integer            'delivery day
  Dim dlhr        As Integer            'delivery hour
  Dim dlmin       As Integer            'delivery minute

  'YYYY-MM-DDTHH:MM:SSZAA:BB
  '1234567890123456789012345

  dlyr  = CInt(mid$(input_item,1,4))
  dlmon = CInt(mid$(input_item,6,2))
  dlday = CInt(mid$(input_item,9,2))
  dlhr  = CInt(mid$(input_item,12,2))
  dlmin = CInt(mid$(input_item,15,2))

  convert_date = DateSerial(dlyr, dlmon, dlday) + TimeSerial(dlhr, dlmin, 0)
End Function

'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' this sub processes the paging response records
'
' Copyright (C) 2001 First Choice Software, Inc. All Rights Reserved
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'section added for PGPT support for RPA customers
Sub process_pgpt_response(full_name as String, response_code As String, _
                          response_time As Date, resp_a_n As Integer)

  Dim ae_rec      As New Record         'record for act_entry
  Dim bulk_rt     As New BulkRetrieve   'retrieve area for page_requests
  Dim bulk_sv     As New BulkSave       'save area for page_requests
  Dim cas_rec     As Record             'case record area
  Dim emp_rec     As Record             'employee record area
  Dim gbs_rec     As Record             'gbst record area
  Dim pg_rec      As New Record         'record for page_request
  Dim pr_rec      As New Record         'record for page_response
  Dim req_length  As String             'request length of message
  Dim req_message As String             'request message
  Dim req_pager   As String             'request device number
  Dim req_type    As String             'request type (API or NOTIFY)
  Dim response    As String             'request message
  Dim rt_list     As List               'list of page_requests
  Dim ser_line    As String             'output line for serial file
  Dim sub_rec     As Record             'subcase record area
  Dim tb_rec      As New Record         'record for time_bomb
  Dim usr_rec     As Record             'user record area
  Dim save_flag   As Boolean            'indicate if save needs to be done

  Dim t_bulk      As New BulkRetrieve   'retrieve area for com_template
  Dim t_list      As List               'list of com_template records
  Dim tmplte_rec1 As Record             'record area for com_template
  Dim tmplte_rec2 As Record             'record area for com_template

  Dim t_in_line   As String             'temp input line read from input file
  Dim str_pos     As String             'position of first space
  Dim keyword     As String             'keyword from response line
  Dim input_item  As String             'item associated to each keyword
  Dim ic          As Integer            'item count

  Dim addr        As String             'variables parsed from response
  Dim cdata       As String
  Dim comment     As String
  Dim cref        As String
  Dim custid      As String
  Dim del_date    As Date
  Dim level       As String
  Dim message     As String
  Dim ncfm_date   As Date
  Dim ndel_date   As Date
  Dim rcvd_date   As Date
  Dim reason      As String
  Dim reply_date  As Date
  Dim req_objid   As Long               'request objid
  Dim resp_type   As String
  Dim seq_num     As String
  Dim token       As String
  Dim ver         As String

  pg_rec.RecordType = "page_request"    'define record types
  pr_rec.RecordType = "page_response"
  ae_rec.RecordType = "act_entry"
  tb_rec.RecordType = "time_bomb"

  case_objid     = 0                    'initialize focus objid's
  subcase_objid  = 0                    '
  employee_objid = 0                    '
  user_objid     = 0                    '
  gbst_objid     = 0                    '


  If response_code = "PA" Then
    logmsg 2, "getting objid for " & full_name
    req_objid = Mid(FileParse$(full_name,3),2,9)
    reason = "RPA Accepted Page"
  Else
    logmsg 2, "opening " & full_name

    open full_name For Input As #7        'open response file (already tested for errors)
    While Not EOF(7)
      Line Input #7, t_in_line            'read page response file
      t_in_line = Trim(t_in_line)
      ic = ItemCount(t_in_line," ")
      If ic > 1 Then
        keyword = Item$(t_in_line,1,1," ")
        input_item = Item$(t_in_line,2,ic," ")
        Select Case keyword
          Case "VER"                        'VER 2.00
            ver = input_item
          Case "TYPE"                       'TYPE DL
            resp_type = input_item
          Case "CUSTID"                     'CUSTID 3477803
            custid = input_item
          Case "CREF"                       'CREF 1536870919
            cref = input_item
            req_objid = CLng(mid$(input_item,2,9))
          Case "ADDR"                       'ADDR 80075983524426520
            addr = input_item
          Case "TOKEN"                      'TOKEN
            token = input_item
          Case "CDATA"                      'CDATA Confirmation Response!
            cdata = input_item
          Case "MESSAGE"                    'MESSAGE Test Message
            message = input_item

          'Date fields follow               'All fields containing the date and time shall be in ISO
                                            '8601-compliant format, namely: "YYYY-MM-DDTHH:MM:SSZAA:BB" where:
                                            '    YYYY is the year in the usual Gregorian calendar
                                            '    MM is the month of the year between 01 (January) and 12 (December)
                                            '    DD is the date of the month between 01 and 31
                                            '    T is the constant "T"
                                            '    HH is the number of complete hours passed since midnight (00-23)
                                            '    MM is the number of complete minutes passed since the start of the hour (00?59)
                                            '    SS is the number of complete seconds passed since the start of the minute (00?59)
                                            '    Z is a constant "+" or "-" depending on whether the time zone is ahead or behind universal time (UTC).  Universal time is based on the time at the zero meridian which goes through Greenwich in London, England.
                                            '    AA is the number of hours HH is ahead or behind UTC.
                                            '    BB is the number of minutes MM is ahead or behind UTC.

          Case "RCVD"                       'RCVD 2002-04-03T11:32:47-5:00
            rcvd_date = convert_date(input_item)
          Case "REPLY"                      'REPLY 2002-04-03T11:32:47-5:00
            reply_date = convert_date(input_item)
          Case "DEL"                        'DEL 2002-04-03T11:32:49-5:00
            del_date = convert_date(input_item)
          Case "NDEL"                       'NDEL 1999-10-26T12:01:00+06:00
            ndel_date = convert_date(input_item)
          Case "NCFM"                       'NCFM 1999-10-26T12:01:00+06:00
            ncfm_date = convert_date(input_item)

          'Reason field follows             'All fields translated according to ri020308.rtf from RPA
          Case "REASON"
            Select Case input_item
              Case "AM"
                reason = "Detected an answering machine"
              Case "BS"
                reason = "Busy; telephone number dialed was busy"
              Case "CC"
                reason = "Cannot connect"
              Case "CH"
                reason = "Changed; area code or telephone number has been changed"
              Case "DA"
                reason = "Dead air; telephone number dialed does not answer and RPAWireless was unable to detect ringing"
              Case "DC"
                reason = "Disconnect; telephone network indicates the telephone number dialed has been disconnected"
              Case "DT"
                reason = "No dial tone"
              Case "IV"
                reason = "Invalid number; telephone network indicates the telephone number dialed is an invalid number or is not in service"
              Case "LV"
                reason = "Live voice; telephone number dialed was answered by a live person"
              Case "NA"
                reason = "No answer; telephone number dialed rings, but is not answered"
              Case "NF"
                reason = "Not found"
              Case "NM"
                reason = "No modem; telephone number dialed does not terminate at a modem as required for messages sent to alphanumeric pagers"
              Case "NN"
                reason = "No device address in registered database"
              Case "NP"
                reason = "Cannot be sent"
              Case "OA"
                reason = "Operator aborted; an RPA Wireless operator aborted the delivery attempt"
              Case "TI"
                reason = "Tone intercept; telephone network indicates the telephone number dialed cannot be reached at this time"
              Case "UN"
                reason = "Undetermined failure"
              Case "XF"
                reason = "IXO modem failure; possible invalid alphanumeric pin number or acknowledgment"
              Case "XN"
                reason = "Negative IXO acknowledgment; it is possible the length of the message being sent exceeds the pager's maximum message length "
              Case "XP"
                reason = "IXO invalid pager number; invalid alphanumeric pin number"
            End Select
          Case "LEVEL"                      'LEVEL 1
            level = input_item
          Case "COMMENT"                    'COMMENT
            comment = input_item
          Case "SEQ_NUM"                    'SEQ_NUM 1536870919
            seq_num = input_item
          Case "TOKEN"                      'TOKEN
            token = input_item
        End Select
        logmsg 3, "read in " & t_in_line
      End If
    Wend
    logmsg 3, "closing " & full_name
    close #7                              'close page response file
  End If

  Set bulk_sv = New BulkSave

  If IsNumeric(req_objid) Then
    logmsg 3, "req_objid = " & CStr(req_objid)
  Else
    logmsg 2, "Invalid cref in response text"
  End If

  If (resp_a_n = 0 and track_api_request) or _        'update request record
     (resp_a_n = 1 and track_notify_request) then     'if tracking requests
      bulk_rt.SimpleQuery  0, "page_request"          'get page_request record
      bulk_rt.AppendFilter 0, "objid", cbEqual, req_objid
      bulk_rt.RetrieveRecords
      Set rt_list = bulk_rt.GetRecordList(0)
      If rt_list.count > 0 Then
        Set pg_rec = rt_list.ItemByIndex(0)           'load record and update fields
        pg_rec.SetField "last_response_code", response_code
        logmsg 2, CStr(response_time)
        pg_rec.SetField "last_response_date", format(response_time, "c")
        bulk_sv.UpdateRecord pg_rec                   'put record into bulk-save
        save_flag = True                              'set save trigger
      Else
        logmsg 2, "page request record not found"
        Exit Sub
      End If
  Else
      Exit Sub
  End If
  logmsg 3, "in response code 2"

  bulk_rt.SetRoot pg_rec                              'set page as root
  bulk_rt.TraverseFromRoot 0, "page_request2employee" 'get employee
  bulk_rt.TraverseFromRoot 1, "page_request2case"     'get case
  bulk_rt.TraverseFromRoot 2, "page_request2subcase"  'get subcase
  bulk_rt.TraverseFromParent 3, "employee2user", 0    'get employee-user record
  bulk_rt.SimpleQuery 4, "gbst_elm"                   'get gbst record
  bulk_rt.AppendFilter 4, "rank", cbEqual, 90221
  bulk_rt.SimpleQuery 5, "user"                       'get default user record
  bulk_rt.AppendFilter 5, "login_name", cbEqual, user_name
  bulk_rt.RetrieveRecords

  If (resp_a_n = 0 and track_api_response = "ALL ") or _      'build response record
     (resp_a_n = 1 and track_notify_response = "ALL ") then   'if tracking all responses
      pr_rec.SetField "creation_time", App.CurrentDate
      pr_rec.SetField "response_time", format(response_time, "c")
      pr_rec.SetField "response_code", response_code

      pr_rec.SetField "response_reason", reason
      pr_rec.SetField "response_addr", addr
      If del_date > 0 Then
        pr_rec.SetField "delivery_time", Format(del_date,"c")
      End If
      pr_rec.SetField "confirmation", cdata

      bulk_sv.InsertRecord pr_rec                     'put in bulk_save and add relation
      bulk_sv.RelateRecordsToId pr_rec, "page_request", req_objid, "page_response2page_request"
      save_flag = True                                'set save trigger
      logmsg 2, "page response record created"
  End If
  logmsg 3, "in response code 3"

'************
  If (resp_a_n = 0 and create_api_response_focus_act_entry) or _    'build act_entry record
     (resp_a_n = 1 and create_notify_response_focus_act_entry) then 'if required
      logmsg 2, "create act_entry for focus from response"

      Set rt_list = bulk_rt.GetRecordList(0)
      If rt_list.count > 0 Then                   'if employee was found,put in emp_rec
        Set emp_rec = rt_list.ItemByIndex(0)
        employee_objid = emp_rec.GetField("objid")
      End If

      Set rt_list = bulk_rt.GetRecordList(1)
      If rt_list.count > 0 Then                   'if case was found,put in cas_rec
        Set cas_rec = rt_list.ItemByIndex(0)
        case_objid = cas_rec.GetField("objid")
      End If

      Set rt_list = bulk_rt.GetRecordList(2)
      If rt_list.count > 0 Then                   'if subcase was found,put in sub_rec
        Set sub_rec = rt_list.ItemByIndex(0)
        subcase_objid = sub_rec.GetField("objid")
      End If

      Set rt_list = bulk_rt.GetRecordList(3)
      If rt_list.count > 0 Then                   'if user was found,put in usr_rec
        Set usr_rec = rt_list.ItemByIndex(0)
        user_objid = usr_rec.GetField("objid")
      Else
        Set rt_list = bulk_rt.GetRecordList(5)
        If rt_list.count > 0 Then                 'if user wasn't found, use default user for usr_rec
          Set usr_rec = rt_list.ItemByIndex(0)
          user_objid = usr_rec.GetField("objid")
        End If
      End If

      Set rt_list = bulk_rt.GetRecordList(4)
      If rt_list.count > 0 Then                   'if gbst_elm was found,put in gbs_rec
        Set gbs_rec = rt_list.ItemByIndex(0)
        gbst_objid = gbs_rec.GetField("objid")
      End If

      ae_rec.SetField "act_code",   90221
      ae_rec.SetField "entry_time", App.CurrentDate
      ae_rec.SetField "addnl_info", "Code:"         & response_code       & " " & _
                                    "Reason:"       & reason & " " & _
                                    "Confirmation:" & cdata
      bulk_sv.InsertRecord ae_rec
      bulk_sv.RelateRecords ae_rec, pg_rec, "act_entry2page_request"
      If case_objid > 0 Then
        bulk_sv.RelateRecordsToId ae_rec, "case", case_objid, "act_entry2case"
      End If
      If subcase_objid > 0 Then
        bulk_sv.RelateRecordsToId ae_rec, "subcase", subcase_objid, "act_entry2subcase"
      End If
      If employee_objid > 0 Then
        bulk_sv.RelateRecordsToId ae_rec, "employee", employee_objid, "act_entry2employee"
      End If
      If user_objid > 0 Then
        bulk_sv.RelateRecordsToId ae_rec, "user", user_objid, "act_entry2user"
      End If
      If gbst_objid > 0 Then
        bulk_sv.RelateRecordsToId ae_rec, "gbst_elm", gbst_objid, "entry_name2gbst_elm"
      End If
      save_flag = True                                'set save trigger
  End If
  If save_flag Then
    bulk_sv.Save
    save_flag = False                                 'clear save trigger
  End If

  Set bulk_sv = New BulkSave
  If (resp_a_n = 0 and create_api_response_event) Then     'create time_bomb record
      logmsg 2, "create time_bomb for API response"

      Set rt_list = bulk_rt.GetRecordList(0)
      If rt_list.count > 0 Then                   'if employee was found,put in emp_rec
        Set emp_rec = rt_list.ItemByIndex(0)
        employee_objid = emp_rec.GetField("objid")
      End If

      'get records to use for time_bomb relations
      t_bulk.Clear
      t_bulk.SimpleQuery 0, "com_tmplte"
      t_bulk.AppendFilter 0, "title", cbEqual, "FCS Paging Response Action"
      t_bulk.SimpleQuery 1, "com_tmplte"
      t_bulk.AppendFilter 1, "title", cbEqual, "FCS Paging Response"
      t_bulk.RetrieveRecords
      Set t_list = t_bulk.GetRecordList(0)
      If t_list.count > 0 Then                        'event log com template
        Set tmplte_rec1 = t_list.ItemByIndex(0)
      End If
      Set t_list = t_bulk.GetRecordList(1)
      If t_list.count > 0 Then                        'business rule com template
        Set tmplte_rec2 = t_list.ItemByIndex(0)
      End If

      logmsg 2, "time_bomb: cmit_creator2employee = " & employee_objid
      logmsg 2, "time_bomb: trckr_info2com_tmplte = " & tmplte_rec1.GetField("objid")
      logmsg 2, "time_bomb: rule2com_tmplte = " & tmplte_rec2.GetField("objid")

      tb_rec.SetField "title",         "FCS Paging Page Response"
      tb_rec.SetField "escalate_time", "1/1/1800"
      tb_rec.SetField "end_time",      App.CurrentDate
      tb_rec.SetField "focus_lowid",   pr_rec.GetField("objid")
      tb_rec.SetField "focus_type",    3551
      tb_rec.SetField "time_period",   0
      tb_rec.SetField "flags",         165937154      '(2532 * 65536) + 2
      tb_rec.SetField "left_repeat",   0
      bulk_sv.InsertRecord tb_rec
      if employee_objid > 0 then
        bulk_sv.RelateRecordsToId tb_rec, "employee", employee_objid, "cmit_creator2employee"
      else
        bulk_sv.RelateRecordsToId tb_rec, "employee", app.EmployeeObjid, "cmit_creator2employee"
      end if
      bulk_sv.RelateRecordsToId tb_rec, "com_tmplte", tmplte_rec1.GetField("objid"), "trckr_info2com_tmplte"
      bulk_sv.RelateRecordsToId tb_rec, "com_tmplte", tmplte_rec2.GetField("objid"), "rule2com_tmplte"
      save_flag = True                                'set save trigger
  End If

'************

  If save_flag Then
    bulk_sv.Save
  End If
End Sub

'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' Main program
'
' Copyright (C) 2001 First Choice Software, Inc. All Rights Reserved
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Sub pg_daemon()
  Dim file_name  As String              'file name to process
  Dim file_type  As String              'file type to process
  Dim full_name  As String              'full pathname of file
  Dim done_name  As String              'full pathname of file after processing
  Dim in_line    As String              'input line read from input file
  Dim next_file  As String              'next file to process
  Dim resp_type  As String              'file type to process
  Dim resp_A_N   As Integer             'response to API(0) or NOTIFY(1)
  Dim ret_val    As Long                'return value
  Dim cycle      As Integer             'cycle count
  Dim f          As Integer             'file count
  Dim f_done     As Integer             'files processed
  Dim cur_time   As Date                'Current date/time in date format
  Dim res_time   As Date                'Response date/time in date format
  Dim t_in_line  As String              'temp input line read from input file
  Dim db         As New SQLDB           'new SQL connection for sleep interval
  Dim sqlcmd     As String              'new SQL command for sleep interval


  cur_time = CDate(App.CurrentDate)     'Get the current time
  cycle_num  = 1                        'do at least 1 cycle
  log_level  = 0                        'set default log level (set to 3 for test)
  sleep_time = 0                        'set default sleep interval

                                        'Accept:	PA or AC
                                        'Reject:	PN or RJ
                                        'Timeout:	TO
                                        'Delivery:	DL
                                        'Non-delivery:	ND
                                        'Confirmation:	CF
                                        'Non-Confirmation:	NC
                                        'CTIM ACK:	TK
                                        'CTIM NAK:	TN
                                        'Unsolicited: UN

  response_types = "AC CF DL NC ND PA PN RJ TK TN TO UN"  'build list of valid response codes
  include_filter = response_types
  exclude_filter = ""

  Select Case Basic.OS                  'set operating system so pathnames will evaluate
    Case 0, 2, 10, 11
      win_type = True
      sep_val = "\"
    Case Else
      win_type = False
      sep_val = "/"
  End Select

' pm_rpa = "pm"                         'use this variable to indicate use of pagemate (pm)
' pm_rpa = "rpa"                        'or RPA (rpa) services [original:rpa, new:pgpt]
  pm_rpa = "pgpt"

  locale = "EN_US"
  If locale = "" Then
    locale = Environ$("LC_STRING")      'set locale so get_sprintf will find strings
  End If
  If locale = "" Then
    locale = Environ$("LC_ALL")
  End If
  If log_level = 3 Then                 'have to change the value up above about 23 lines
    debug.print "locale = " & locale & "; cur_dir = " & CurDir$
  End If

  ret_val = open_error_files()          'open error file
  If ret_val < 0 Then                   'if not opened, error and leave
    tmp_string = get_sprintf(11110, locale, "", err_string)
    error_msg tmp_string, -1
    if tmp_string = "" then
      debug.print "error file open error on " & log_file
    end if
    Exit Sub
  End If

  sv_key = Mid$(App.ServerName,1,2)     'get server name
  db_key = Mid$(App.DatabaseName,1,2)   'get database name
  user_name = App.UserName              'get user name

  If log_level = 3 Then                 'print file name to be read
    debug.print "reading ini file from " & CurDir$ & sep_val & "pg.ini"
  End If

  ret_val = read_ini_file()             'process ini file

  If ret_val < 0 Then                   'If ini file not found, error and leave
    tmp_string = get_sprintf(11110, locale, "", err_string)
    error_msg tmp_string, -1
    if tmp_string = "" then
      debug.print "ini file open error on " & log_file
    end if
    Exit Sub
  End If

  If log_level > 0 Then                 'if logging is turned on, open log file
    log_file = log_dir & "pg_" & Format(cur_time, "yyyymmdd") + ".log"
    ret_val = open_pg_files()
    If ret_val < 0 Then
      tmp_string = get_sprintf(11110, locale, "", err_string)
      error_msg tmp_string, -1
      if tmp_string = "" then
        debug.print "log file open error on " & log_file
      end if
      Exit Sub
    End If
  End If

  get_config_items                      'read and load config items from database

  'main source code area
  For cycle = 1 to cycle_num
    logmsg 2, "cycle " & cycle
    f_done = 0

    If pm_rpa = "pgpt" Then
      pg_dir = from_rpa_dir                           'overide directory for pgpt
      fcs_dir = send_rpa_dir                          'overide directory for pgpt
    End If

    '********************************************************************
    file_type = fcs_dir & "fcspr.*.req"               'process page request files
    file_name = Dir$(file_type)                       'find first qualifying page file
    f = 1
    While (file_name <> "") and (f <= max_request)    'process until done or over limit
      full_name = fcs_dir & file_name                 'build full pathname
      done_name = fcs_dir & "," & file_name           'build done pathname

      logmsg 2, "Processing request " & full_name     'debug message

      If FileLen(full_name) > 0 Then                  'check for empty file
        On Error Goto missing_req_file                'set error trap
        Open full_name For Input As #5                'open request file

                                                      'Reset the in_line variables
        in_line   = ""
        t_in_line = ""
                                                      'Need to get all lines from page request file.
                                                      'This allows multi-line messages to be sent.
                                                      'Add a space (not a CRLF) between lines
        While Not EOF(5)
          Line Input #5, t_in_line
          If in_line = "" Then
            in_line = t_in_line
          Else
            in_line = in_line + Space(1) + t_in_line
          End If
        Wend

        On Error Goto 0                               'kill the trap before the function

        process_request in_line                       'process page request
        On Error Goto missing_req_file

        Close #5                                      'close page request file
      Else
        logmsg 1, "ERROR: " & full_name & " is empty" 'log message for empty file
      End If

      Name full_name As done_name                     'rename request file when done
missing_req_file:
      if err > 0 then                                 'if there was an error...
        logmsg 2, "error code = " & err               'log error code...
        Close #5                                      'and close file
      End If
      f = f + 1                                       'increment request files processed
      f_done = f_done + 1                             'increment files processed counter
      file_name = Dir$                                'get next file
      On Error Goto 0
    Wend

    '********************************************************************
    'process page response files
    file_type = pg_dir & "*"                          'process page response files

    file_name = Dir$(file_type)                       'find first qualifying response file
    f = 1
    While (file_name <> "") and (f <= max_response)   'process until done or over limit

      full_name = pg_dir & file_name                  'build full pathname
      done_name = pg_dir & "," & file_name            'build done pathname

      res_time = FileDateTime(full_name)              'get time stamp on file
      If Format(res_time,"yyyy") < 1000 Then res_time = DateAdd("yyyy", 1900, res_time)

      resp_type = Right$(file_name,2)                 'if filename ends with "ignore code",

      If pm_rpa = "pgpt" Then                         'pgpt files end in PTO, so get 2 characters
        resp_type = Mid(Right$(file_name,5),1,2)      'just before the PTO tag
      End If

      If InStr(ignore_filter,resp_type) Or _          'or has a comma, skip it
         InStr(file_name,",") > 0 Then
          logmsg 2, "skipping " & full_name
          goto skip_response_file
      End If

      If InStr(include_filter,resp_type) = 0 or _     'Compare file type againt filters
         InStr(exclude_filter,resp_type) > 0  Then    'delete it and skip if not found
          logmsg 2, "removing " & full_name
          kill full_name
          goto skip_response_file
      End If

      If IsNumeric(Mid$(file_name,1,1)) Then
        resp_A_N = CInt(Mid$(file_name,1,1))          'get API/NOTIFY indicator
      Else
        logmsg 2, "removing " & full_name             'remove files not starting with a number
        kill full_name
        goto skip_response_file
      End If

      logmsg 2, "Processing " & resp_type & " response in " & full_name 'debug message

                                                        'check for empty files (PA,PN,TO,TK,TC)
                                                        'uncomment to allow PA to get updated on response record
     'If FileLen(full_name) > 0 or resp_type = "PA" Then
      If FileLen(full_name) > 0 Then
        If pm_rpa = "pgpt" Then
          'section added for PGPT support for RPA customers
          On Error Goto missing_res_file                'set error trap
          If FileLen(full_name) > 0 Then
            Open full_name For Input As #7              'open response file for error test
            Line Input #7, in_line                      'read page response file for error test
            Close #7                                    'close page response file for error test
            On Error GoTo 0                             'reset error handling
            process_pgpt_response full_name, resp_type, res_time, resp_A_N   'process pgpt response
          Else
            process_pgpt_response full_name, resp_type, res_time, resp_A_N   'process pgpt response
          End If
        Else
          On Error Goto missing_res_file                'set error trap
          If FileLen(full_name) > 0 Then
            Open full_name For Input As #7              'open response file
            Line Input #7, in_line                      'read page response file
            Close #7                                    'close page response file
            On Error GoTo 0                             'reset error handling
          Else
            in_line = full_name                         'pass full_name as PA response
          End If

'       '01/25/99 Added Checking if there is 'CTIM' in the CF file, skip the process, per Sam Tyson
'       '02/15/99 Added checking if repsonse type is "TK", skip the process for "TK".
'
'         If (resp_type = "CF" and Instr(in_line, "CTIM") = 0) or resp_type <> "CF" Then
'           If resp_type <> "TK" Then
              process_response in_line, resp_type, res_time, resp_A_N    'process page response
'           End If
'         End If
        End If
      Else
        logmsg 1, "ERROR: " & full_name & " is empty" 'log message for empty file
      End If

      Name full_name As done_name                     'rename request file when done
      f = f + 1                                       'increment response files processed
      f_done = f_done + 1                             'increment files processed counter

missing_res_file:
      If Err > 0 Then                                 'if there was an error...
        logmsg 2, "response file error code = " & Err 'log error code...
        Close #7                                      'and close file
        Err.Number = -1
      End If

skip_response_file:
      file_name = Dir$                                'get next file
      On Error Goto 0
    Wend
    '********************************************************************
                                                      ' sleep between empty scans
    If f_done = 0 and sleep_time > 0 Then
      logmsg 2, "Sleeping for " & sleep_time & " seconds"
                                                      ' If this is Windows, use the regular sleep
                                                      ' If this is UNIX, then...
                                                      '    If this is Sybase. use the database waitfor command
                                                      '    If this is Oracle, use dbms_lock.sleep command
                                                      '    Oracle Note: May need to install $ORACLE_HOME/rdbms/admin/dbmslock.sql
                                                      ' Reason: Sleep on UNIX causes high CPU utilization.
                                                      ' See PD07449 on ClearAnswer for more details
      If (Basic.OS = ebWin16) OR (Basic.OS = ebWin32) Then
         Sleep(sleep_time * 1000)
      Else
        If UCase$(db_type) = "SYBASE" Then
           sqlcmd = "waitfor delay '00:00:" & CStr(sleep_time) & "'"
           db.Execute sqlcmd
        End If
        If UCase$(db_type) = "ORACLE" Then
           sqlcmd = "execute dbms_lock.sleep(" & CStr(sleep_time) & ")"
           db.Execute sqlcmd
        End If
      End If

    End If
    logmsg 2, "End of cycle " & cycle
  Next cycle

end_it:
  Close #4
  logmsg 2, "closing main routine"

  On Error Resume Next

  mkdir(fcs_dir & "done")

  file_type = fcs_dir & ",fcspr.*.req"              'find processed files
  file_name = Dir$(file_type)                       'find first qualifying file
  f = 0
  While (file_name <> "")                           'process until done
    f = f + 1                                       'increment response files processed
    full_name = fcs_dir & file_name                 'build full pathname
    done_name = fcs_dir & "done" & sep_val & file_name 'build done pathname
    logmsg 2, "moving " & full_name
    Name full_name As done_name                     'move file to done directory

    If Err = 58 Then                                'If file already exists in done folder, remove it
      Kill full_name
      Resume
    End If

    file_name = Dir$                                'get next file
  Wend

  If f > 0 Then
    logmsg 2, "moved " & f & " fcs_dir done files"
  End If

  mkdir(pg_dir & "done")
  file_type = pg_dir & ",*"                         'find processed files
  file_name = Dir$(file_type)                       'find first qualifying file
  f = 0
  While (file_name <> "")                           'process until done
    f = f + 1                                       'increment response files processed
    full_name = pg_dir & file_name                  'build full pathname
    done_name = pg_dir & "done" & sep_val & file_name 'build done pathname
    logmsg 2, "moving " & full_name
    Name full_name As done_name                     'move file to done directory

    If Err = 58 Then                                'If file already exists in done folder, remove it
      Kill full_name
      Err.Clear
    End If

    file_name = Dir$                                'get next file
  Wend

  If f > 0 Then
    logmsg 2, "moved " & f & " pg_dir done files"
  End If

  If Err <> 0 And Err <> 58 Then
    logmsg 2, "The following error occurred: " & Err & ":" & error(err) & " on line " & Erl
  End If

  On Error Goto 0

  'respawn this process to clean up associated memory block usage/leakage
  ret_val = Shell(shell_file)

End Sub
